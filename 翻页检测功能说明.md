# 绘本阅读APP - 翻页检测功能说明

## 功能概述

本项目成功实现了基于 ONNX Runtime 和 MobileNetV2 模型的智能翻页检测功能，能够实时监测用户翻页动作并进行页面计数。

## 核心功能

### 1. 翻页检测服务 (`lib/services/page_turn_detector.dart`)
- **特征提取**: 使用 MobileNetV2 模型从相机图像中提取特征向量
- **相似度计算**: 通过余弦相似度比较连续帧之间的差异
- **翻页判断**: 基于相似度阈值和稳定帧数量判断翻页动作
- **实时处理**: 支持相机图像流的实时处理

### 2. 增强的阅读页面 (`lib/pages/reading_page.dart`)
- **摄像头集成**: 实时相机预览和图像捕获
- **状态显示**: 显示检测状态、页面计数、相似度等信息
- **交互反馈**: 翻页检测后的弹窗提醒和确认
- **错误处理**: 完善的错误提示和状态管理

## 技术特点

### 1. 图像预处理
- 支持 YUV420 和 BGRA8888 两种相机图像格式
- 自动图像缩放和中心裁剪
- ImageNet 标准化预处理

### 2. 模型推理
- 使用 ONNX Runtime 进行高效推理
- 输入尺寸: 224x224x3 (符合 MobileNetV2 要求)
- 支持异步推理，不阻塞UI线程

### 3. 检测算法
- **相似度阈值**: 0.75 (可调整)
- **稳定帧数**: 3帧 (确保翻页完成)
- **特征历史**: 保存最近5帧特征用于比较

## 界面功能

### 1. 实时显示
- 摄像头预览窗口
- 当前页面计数
- 实时相似度百分比
- 页面稳定度进度条
- 模型加载状态指示

### 2. 用户交互
- 开始/停止阅读按钮
- 翻页检测弹窗提醒
- 错误信息对话框
- 状态文本实时更新

## 使用流程

1. **初始化阶段**
   - 请求摄像头权限
   - 初始化摄像头控制器
   - 加载 ONNX 模型文件
   - 设置回调函数

2. **开始阅读**
   - 启动图像流捕获
   - 开始特征提取和比较
   - 实时更新检测状态

3. **翻页检测**
   - 连续监测图像相似度
   - 检测到低相似度时标记页面变化
   - 连续稳定帧后确认翻页完成
   - 弹窗提醒并更新页面计数

4. **停止阅读**
   - 停止图像流处理
   - 清理检测状态
   - 释放相关资源

## 配置要求

### 1. 依赖包
```yaml
dependencies:
  onnxruntime: ^1.4.1
  camera: (自定义版本)
  permission_handler: (自定义版本)
  image: ^4.1.7
```

### 2. 模型文件
- 位置: `assets/models/mymobilenetv2.onnx`
- 格式: ONNX
- 输入: [1, 3, 224, 224]
- 输入名称: 'input'

### 3. 权限配置
- 摄像头权限 (自动请求)
- 文件访问权限 (读取模型文件)

## 性能优化

1. **内存管理**
   - 及时释放 ONNX 张量资源
   - 限制特征历史存储数量
   - 异步处理避免内存泄漏

2. **计算优化**
   - 图像预处理优化
   - 异步模型推理
   - 相似度计算优化

3. **用户体验**
   - 实时状态反馈
   - 流畅的UI更新
   - 错误处理和提示

## 扩展功能

### 可能的改进方向
1. **多模型支持**: 支持不同的特征提取模型
2. **参数调优**: 动态调整检测阈值和稳定帧数
3. **历史记录**: 保存阅读历史和翻页时间
4. **语音反馈**: 添加语音提示功能
5. **云端处理**: 支持云端模型推理

## 开发注意事项

1. **模型文件**: 确保模型文件正确放置在 assets 目录
2. **权限处理**: 妥善处理摄像头权限申请
3. **错误处理**: 完善的异常捕获和用户提示
4. **资源释放**: 及时释放相机和模型资源
5. **性能监控**: 关注内存使用和处理延迟

## 测试建议

1. **功能测试**: 测试不同光照条件下的翻页检测
2. **性能测试**: 监控CPU和内存使用情况
3. **边界测试**: 测试快速翻页和慢速翻页场景
4. **兼容性测试**: 在不同设备上测试相机格式支持
5. **稳定性测试**: 长时间运行的稳定性验证

---

该翻页检测功能为绘本阅读APP提供了智能化的页面跟踪能力，通过深度学习技术实现了准确的翻页识别，为用户提供了更好的阅读体验。 